{"componentChunkName":"component---src-templates-blog-post-js","path":"/kubernetes/2024-2study/11.3.3. HPA를 활용한 오토스케일링/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"HPA를 활용한 오토스케일링","date":"November 16, 2024"},"html":"<h1>11.3.3 HPA를 활용한 오토스케일링</h1>\n<p>사용자의 요청을 처리할 때에 있어서 서버의 갯수를 고정해놓으면 리소스를 낭비하게 되며, 부하가 많아지면 서버가 요청을 모두 처리할 수 없는 불상사가 발생할 수 있습니다.<br>\n이때, 서버의 갯수를 사용량에 따라 deployment의 pod 개수를 자동으로 조절하는 <code>HPA(Horizontal Pod Autoscaler)</code> 기능을 제공합니다.</p>\n<h3>metrics-server</h3>\n<p>HPA는 k8s 내장 기능이긴 하지만, 사용하기 위해서는 metrics-server가 필요합니다. 이때, metrics-server는 별도의 리소스 메트릭 수집 도구이며 이게 있어야 HPA가 동작합니다. 해당 장에서는 metrics-server를 설치하여 <code>kubectl top</code>명령어가 정상적으로 작동한다는 가정하에 진행됩니다.</p>\n<h3>simple-hpa.yaml</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVR42p1S2VLDMAzM/8OUHhzTAsMHAG8wfAtHaaG0TdK0TVI3t7NolXC94hmNrPVqLcl27u8eMDwb4fL8CqPhBYanIwy6J+h3jzHonarvdvroHQ3UD3onuqfxnJ6cw4MObq5v4Wy3IWbvM7iuh9nsQ/fLpYs43iFJErU0TdUbs2+wNv6DieV5DscYI2IuzM5oIsGiKGCtxX+WQyF36WEnFcVR/C1UFiWqskJd12q2sihyuaj6wSrBcsHIQ4s5WZZhuXDVolaQYvt9gizNNIkYE/cmaUQlZjIxY8jLFbO1hcOD+ccC45dXTKdv2Kw3Wk2e5SrMPTllWSJNsmYcgjGmYJo2vK+qHXHyADH4OL6/wjpYI1gFSKRCJrPqlcSe6yPwA4RhhO0mhOf54Px1HO2YVJBJL89jTCdTTYzCUMVDMc51Pl/g6fEZ4/FEOG94l19AT7GqKpsu2hGoIEvnl2GrfOGvZW2t5FAuaCySytdYsQvhsivmcNbVr4f6BClwonufJKS0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"\"\n        src=\"/static/8d89899cd6cb982cb171fa4c35d7f114/5a190/3.1.png\"\n        srcset=\"/static/8d89899cd6cb982cb171fa4c35d7f114/772e8/3.1.png 200w,\n/static/8d89899cd6cb982cb171fa4c35d7f114/e17e5/3.1.png 400w,\n/static/8d89899cd6cb982cb171fa4c35d7f114/5a190/3.1.png 800w,\n/static/8d89899cd6cb982cb171fa4c35d7f114/c1b63/3.1.png 1200w,\n/static/8d89899cd6cb982cb171fa4c35d7f114/e4ba2/3.1.png 1468w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이를 살펴보면 <code>CPU Utilization</code>이라는 부분이 있는데, CPU 사용량에 따라 pod의 개수를 조절하겠다는 의미입니다.</p>\n<p>아래 사진을 보면 현재 사용량이 60%는 50% 이상이므로 pod의 개수를 2개로 늘리는 것을 확인할 수 있습니다.<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA30lEQVR42nVRCQ6EIBDz/19dOQTk1i4dg9FsdpIKlNo5WDCitQalFFa1wlor4DnFhGec54ngA6yx2LYNxhpoo+Gcw3Ecolko6r3LodYKM8RxGJEnppB7Jr40Bjln1Fahtca+78K/DLnGGCUbBTQiSqlyDiGMfRGNd1447lmp917uxJAfGrbe0I8umXhJtNaH6XmbE9TONeeEUsvN3YbPuKoq0t5MRm6OgJjB5CmlF/djSDM+yrp+pBVrt9GWk0fSWknrnB+N2PKs7K8hRRw6DfgzIXMNnKO/OSaj9lkdDb+J7SQraxmAdQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3.2\"\n        title=\"\"\n        src=\"/static/8c22d71c887a95f4c56d8ab20dfa8199/5a190/3.2.png\"\n        srcset=\"/static/8c22d71c887a95f4c56d8ab20dfa8199/772e8/3.2.png 200w,\n/static/8c22d71c887a95f4c56d8ab20dfa8199/e17e5/3.2.png 400w,\n/static/8c22d71c887a95f4c56d8ab20dfa8199/5a190/3.2.png 800w,\n/static/8c22d71c887a95f4c56d8ab20dfa8199/c1b63/3.2.png 1200w,\n/static/8c22d71c887a95f4c56d8ab20dfa8199/10ab7/3.2.png 1552w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이어서 pod가 두개인 경우에도 사용량이 50% 이상이면 pod의 개수를 늘리는 것을 확인할 수 있습니다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEUlEQVR42nWSiW6EMAxE+f8/ZQu5L47g5nlFtaxUS1bCxJmMx0y9d1nXVay1mt55McZISlmI67p0PY5D1mXUGSvOOc1lWaS19qibtm0T550Ya6TWOoiSmPVNeByn7PuueAxRSqnSahNnneSSFffeSx04dZBOvOAGiEqKSym6jzFqEecxJsVKLkpCB/pALe+uIB24KuQCJBwCbm3TzDnLeZ66RwF5E5LcY+UuZ9QpoXwEPlF4+/JfYBNkdPAdSshgNM8u+yDlAt/4mYeXqMWCWzVnPH7ve7+ehLzGxOZ5ltfrZ3gSFAsxKCkZQtCkxbuLMHxMKf7592iZCaEMJTcBipyzYwBBcf4GxYdqhoLK75Z/AUUyb0ABI7pXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3.3\"\n        title=\"\"\n        src=\"/static/507fd9a1f36237b1f8476ad4e8d2ffc3/5a190/3.3.png\"\n        srcset=\"/static/507fd9a1f36237b1f8476ad4e8d2ffc3/772e8/3.3.png 200w,\n/static/507fd9a1f36237b1f8476ad4e8d2ffc3/e17e5/3.3.png 400w,\n/static/507fd9a1f36237b1f8476ad4e8d2ffc3/5a190/3.3.png 800w,\n/static/507fd9a1f36237b1f8476ad4e8d2ffc3/c1b63/3.3.png 1200w,\n/static/507fd9a1f36237b1f8476ad4e8d2ffc3/2215f/3.3.png 1548w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2>HPA와 함께 Deployment 생성</h2>\n<p>HPA가 의도대로 작동하고 있는지 확인하기 위하여 deployment와 함께 생성합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAlUlEQVR42o1P2Q6DMAzr///n6AQ9GT3ogZdkEtrbZimy/RDHUSklmM3AGgvvA7zzxF78cSSUXHDWU7i3DsZ1XTd/a4bqvSPnDA7OKYuutVLYIfr1+jBPa02W5px3GGvGGEO8ijFieSxY1w3GGGzEWj+hFw1rnbTP1O5fKL7saJHfdfTuvu8IISCQjyGilHo3mmP+bPgG2GU3xCnNGCEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4\"\n        title=\"\"\n        src=\"/static/ae5094a3640eccbc081654ffa8801073/5a190/3.4.png\"\n        srcset=\"/static/ae5094a3640eccbc081654ffa8801073/772e8/3.4.png 200w,\n/static/ae5094a3640eccbc081654ffa8801073/e17e5/3.4.png 400w,\n/static/ae5094a3640eccbc081654ffa8801073/5a190/3.4.png 800w,\n/static/ae5094a3640eccbc081654ffa8801073/c1b63/3.4.png 1200w,\n/static/ae5094a3640eccbc081654ffa8801073/a2792/3.4.png 1462w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이때, HPA의 목록을 확인해보면 디플로이면트에 속한 파드의 CPU 평균 사용률을 확인할 수 있습니다.<br>\ntargets가 0/50%라는 것은 현재 사용량이 0%이며, 50% 이상이면 pod의 개수를 늘리겠다는 의미입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAYUlEQVR42iVO0Q4AIQjq/3/1ypfUrFVclJtjMASTqkKKoHlD/jK0KjhrrYt7b5gaIgJ60N2vJ6LD7OljDMw5aUaiKCLovV8sucDNUWs9ew5boJxCcoaxmE8whPwV6QsE8AMd45s/59M5ugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3.5\"\n        title=\"\"\n        src=\"/static/a47f3a756499cb7e7fc6bb2f230cb9c8/5a190/3.5.png\"\n        srcset=\"/static/a47f3a756499cb7e7fc6bb2f230cb9c8/772e8/3.5.png 200w,\n/static/a47f3a756499cb7e7fc6bb2f230cb9c8/e17e5/3.5.png 400w,\n/static/a47f3a756499cb7e7fc6bb2f230cb9c8/5a190/3.5.png 800w,\n/static/a47f3a756499cb7e7fc6bb2f230cb9c8/c1b63/3.5.png 1200w,\n/static/a47f3a756499cb7e7fc6bb2f230cb9c8/07d7d/3.5.png 1478w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>요청을 한번에 많이 보내서 CPU 사용량을 높여보겠습니다. (이때 사용한 도구는 apache benchmark입니다.)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSElEQVR42p2S247DMAhE8/+/2tTxPY5zYTlk3VWrfWokBCZgZgZPvXeZ56d47yWEIItbZF2bxJikllV636XWVXOrBB/kOA7hG/66LjnP85WbCFJKWhyllCLbtlnRt9+074e45yLeeUP3eMyGpNYqTVGttUnJxOpLtXxVH0O04TB4Q0gSeqCkgcvuuJjlnM1DmXzOmldLOdnFfesvdDCbuJViJjONJoZ8TTnF+4J936W127Oord10mv6DLjV/1s2o+5R7mlUz0IXgxTknOWWjHZZg2/Uau6czzWx5+hJijFZD7pLrcyk3TWhj6MNkk4Gz6odODB01Ywn/UqYZ4WkYi6AJpCPH0jhjoEMatMeQBT+GTARcuNqzuC9Dp7HBrrFfvKFlAGwSsihdzgxg8/TblhHX6fszjRQJza211zP49EOzt9xvfB6n/ACD81wC+X0ehwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3.6\"\n        title=\"\"\n        src=\"/static/d847d9abf1d4c8510189a02d993f22cd/5a190/3.6.png\"\n        srcset=\"/static/d847d9abf1d4c8510189a02d993f22cd/772e8/3.6.png 200w,\n/static/d847d9abf1d4c8510189a02d993f22cd/e17e5/3.6.png 400w,\n/static/d847d9abf1d4c8510189a02d993f22cd/5a190/3.6.png 800w,\n/static/d847d9abf1d4c8510189a02d993f22cd/c1b63/3.6.png 1200w,\n/static/d847d9abf1d4c8510189a02d993f22cd/67a79/3.6.png 1408w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>터미널을 열어서 HPA를 확인해보면 pod가 늘어난 것을 확인할 수 있습니다.</p>\n<ul>\n<li>이때, kube controller는 metrics-server가 제공하는 API로부터 메트릭 정보를 받아오는데, 이는 --horizontal-pod-autoscaler-sync-period 옵션으로 설정할 수 있습니다. 기본값은 15초이며, 이는 15초마다 메트릭 정보를 받아오는 것을 의미합니다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABCUlEQVR42l1Ri46DMAzj/7/xgJO4IXZQ+uJdiheXMaFFipKQ4DhuNk0T+l5jGAZYY7GuK74thIAYY+ox37Yt+ZWzF48Dh3imVI/Ho06AVfWHPC9gBFhrg06p9L0oSjyf/2jbFt55dF0HYy34r7UuxXleTsB4RClmLMvyYbLve/LPdvHjzeBuV33vZVprNE2DcRgxTzOCALG5E0QGnDDywtI5h3EcRZ4+zVqpORfCOZ+IiGfUkCcoOc8YObM9c57HM6gb2fMsgl6suejO7Moz7z3K8jdpV1UVfvI81aXoxh7BuLSu67SYstC0LI9xfwPdAMmAzHgKGTCyphTXqzISnA9EbWlc8q0v8xccMR6fxsCPnAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3.7\"\n        title=\"\"\n        src=\"/static/b0c9c4b43942cc6a48a3821ccb36f11e/5a190/3.7.png\"\n        srcset=\"/static/b0c9c4b43942cc6a48a3821ccb36f11e/772e8/3.7.png 200w,\n/static/b0c9c4b43942cc6a48a3821ccb36f11e/e17e5/3.7.png 400w,\n/static/b0c9c4b43942cc6a48a3821ccb36f11e/5a190/3.7.png 800w,\n/static/b0c9c4b43942cc6a48a3821ccb36f11e/c1b63/3.7.png 1200w,\n/static/b0c9c4b43942cc6a48a3821ccb36f11e/0d390/3.7.png 1472w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3>HPA가 불필요한 경우</h3>\n<p>모든 경우에 HPA를 사용하는 것이 좋은 것은 아닙니다. 한가지 예시로 애플리케이션을 초기화할 때 잠시 동안만 CPU를 과도하게 소모하는 JVM 기반 어플리케이션들이 있습니다. 이를 어느 정도 완화하기 위해 주기를 --horizontal-pod-autoscaler-sync-period로 설정할 수 있습니다.</p>"}},"pageContext":{"slug":"/kubernetes/2024-2study/11.3.3. HPA를 활용한 오토스케일링/"}},"staticQueryHashes":[],"slicesMap":{}}